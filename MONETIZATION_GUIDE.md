# Руководство по системе монетизации ComicVerse

## Что реализовано

### 1. База данных (PostgreSQL)
Создана полная схема для работы с платежами:
- **users** - пользователи системы
- **wallets** - кошельки пользователей
- **transactions** - все денежные операции
- **commission_splits** - распределение комиссий (80% автору, 20% владельцу)
- **works** - произведения авторов
- **purchases** - покупки произведений
- **withdrawals** - заявки на вывод средств
- **subscriptions** - подписки на авторов
- **platform_settings** - настройки платформы (реквизиты владельца, проценты комиссии)

### 2. Backend API

#### `/backend/payment` - Приём платежей
- `POST /` - создание платежа с автоматическим распределением комиссий
- `GET /?user_id=N` - получение истории транзакций пользователя

#### `/backend/wallet` - Управление кошельками
- `GET /?user_id=N` - получение баланса и статистики кошелька
- `POST /` (action: withdraw) - создание заявки на вывод средств

#### `/backend/admin` - Админ-панель
- `GET /` - получение всех настроек платформы
- `PUT /` - обновление настроек (в том числе реквизитов владельца)
- `POST /` (action: get_commission_report) - отчёт по заработкам

### 3. Frontend интерфейсы

#### Админ-панель (`/src/components/admin/AdminPanel.tsx`)
- Управление реквизитами владельца платформы (20% комиссия)
- Статистика заработка в реальном времени
- Настройка процентов комиссии
- Отчёты по транзакциям

#### Личный кабинет (обновлён)
- Реальный баланс из базы данных
- История транзакций через API
- Рабочая кнопка вывода средств с проверками
- Модальное окно для заполнения реквизитов

#### Художественный редактор (улучшен)
- Точное отслеживание касаний и мыши (sub-pixel precision)
- Поддержка touch-событий для планшетов
- Новые геометрические фигуры: линия, прямоугольник, круг, треугольник
- Улучшенная кисть с интерполяцией точек
- Инструмент заливки (flood fill)
- Пипетка для выбора цвета
- Предпросмотр фигур в реальном времени

## Как настроить систему комиссий

### Шаг 1: Добавьте секреты ЮKassa (опционально)
Если нужна интеграция с реальными платежами:
1. Зарегистрируйтесь на https://yookassa.ru
2. Получите `YOOKASSA_SHOP_ID` и `YOOKASSA_SECRET_KEY`
3. Добавьте их через интерфейс секретов

### Шаг 2: Настройте реквизиты владельца
1. Войдите как администратор (установите `role: 'admin'` для своего пользователя)
2. Нажмите на иконку настроек в шапке сайта
3. Введите номер телефона/карты для СБП
4. Сохраните изменения

Теперь при каждой покупке:
- 80% автоматически зачисляется автору на баланс в системе
- 20% записывается в таблицу commission_splits с вашими реквизитами

### Шаг 3: Интеграция вывода средств
В `platform_settings` есть поле `platform_owner_account` - туда сохраняются ваши реквизиты.
При обработке выводов используйте эти данные для перечисления денег.

## Схема работы

```
1. Читатель покупает работу (299₽)
   ↓
2. Создаётся transaction
   ↓
3. Создаются 2 commission_split:
   - 239.2₽ (80%) → автору на баланс
   - 59.8₽ (20%) → владельцу (записывается с вашими реквизитами)
   ↓
4. Создаётся purchase (связь user-work-transaction)
```

## API Endpoints (для интеграции)

### Создание платежа
```bash
curl -X POST https://functions.poehali.dev/bee1b44c-67c7-46cf-a0c5-f54c4771d51d \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": 1,
    "work_id": 2,
    "amount": 299,
    "payment_method": "balance"
  }'
```

### Получение баланса
```bash
curl "https://functions.poehali.dev/96f956be-cd72-474f-9b1e-937015b11dbc?user_id=1"
```

### Вывод средств
```bash
curl -X POST https://functions.poehali.dev/96f956be-cd72-474f-9b1e-937015b11dbc \
  -H "Content-Type: application/json" \
  -d '{
    "action": "withdraw",
    "user_id": 1,
    "amount": 500,
    "payment_method": "card",
    "payment_details": {"card_number": "1234"}
  }'
```

### Обновление реквизитов владельца
```bash
curl -X PUT https://functions.poehali.dev/72e3bc71-5445-45ce-ad1f-11671e687ca7 \
  -H "Content-Type: application/json" \
  -d '{
    "key": "platform_owner_account",
    "value": "+79001234567"
  }'
```

### Отчёт по комиссиям
```bash
curl -X POST https://functions.poehali.dev/72e3bc71-5445-45ce-ad1f-11671e687ca7 \
  -H "Content-Type: application/json" \
  -d '{"action": "get_commission_report"}'
```

## Важные моменты

1. **Безопасность**: Реквизиты владельца хранятся в базе данных и доступны только через backend API
2. **Автоматизация**: Распределение комиссий происходит автоматически при каждой покупке
3. **Гибкость**: Проценты комиссии можно изменить через admin API
4. **Минимальный вывод**: По умолчанию 500₽, настраивается через `platform_settings`

## Что дальше

- Подключить webhook от ЮKassa для обработки реальных платежей
- Автоматизировать вывод средств владельцу через API банка
- Добавить графики доходов в админ-панель
- Реализовать подписки на авторов (таблица уже есть)
